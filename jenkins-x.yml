buildPack: entando-maven-lib
pipelineConfig:
  env:
    - name: PIPELINE_CODE
      value: eac
    - name: TEST_DEPLOYMENT
      value: "false"
    - name: SKIP_CHECKSTYLE
      value: "true"
    - name: UPDATE_OWASP_DB
      value: "false"
  pipelines:
    pullRequest:
      postBuild:
        steps: []
#          - sh: mvn versions:set -DnewVersion=$PREVIEW_VERSION
#            name: set-version
#            dir: preview/
#          - sh:  mvn install -Dentando.keycloak.plugin.version=$PREVIEW_VERSION
#            name: war-build
#            dir: preview/
#          - sh:  echo $PREVIEW_VERSION>VERSION && skaffold-build
#            name: container-build
#            dir: preview/
      promote:
        steps:
          - dir: preview
            steps:
              - sh: make preview
                name: make-preview
              - sh: jx preview --name ${REPO_NAME}-${PIPELINE_CODE}pr${PULL_NUMBER} --app $APP_NAME --dir ../.. --namespace ${REPO_NAME}-${PIPELINE_CODE}pr${PULL_NUMBER}
                name: jx-preview
          - sh: |-
                run-post-deployment-tests \
                        -Dkeycloak.enabled=true \
                        -Dkeycloak.realm=entando-development \
                        -Dkeycloak.auth.url=http://kc-${PIPELINE_CODE}pr${PULL_NUMBER}.${ENTANDO_DEFAULT_ROUTING_SUFFIX}/auth \
                        -Dkeycloak.client.id=entando-core \
                        -Dkeycloak.client.secret=930837f0-95b2-4eeb-b303-82a56cac76e6 \
                        -Dkeycloak.public.client.id=entando-web
            name: run-post-deployment-tests
